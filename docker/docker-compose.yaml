services:
  # 统一镜像：包含前端、后端和 MinIO
  aix-db:
    image: apconw/aix-db:1.2.1
    container_name: aix-db-test
    restart: unless-stopped
    # env_file:
    #   - .env
    environment:
      # 时区
      TZ: Asia/Shanghai

      # 后端服务配置
      SERVER_HOST: 0.0.0.0
      SERVER_PORT: ${SERVER_PORT:-8088}
      SERVER_WORKERS: ${SERVER_WORKERS:-2}

      # 数据库配置
      SQLALCHEMY_DATABASE_URI: ${SQLALCHEMY_DATABASE_URI:-postgresql+psycopg2://aix_db:1@pgvector-db:5432/aix_db}

      # MinIO 配置（使用内置的 MinIO）
      MINIO_ENDPOINT: ${MINIO_ENDPOINT:-127.0.0.1:9000}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-}

      # Langfuse 配置（可选）
      LANGFUSE_TRACING_ENABLED: ${LANGFUSE_TRACING_ENABLED:-false}
      LANGFUSE_SECRET_KEY: ${LANGFUSE_SECRET_KEY:-}
      LANGFUSE_PUBLIC_KEY: ${LANGFUSE_PUBLIC_KEY:-}
      LANGFUSE_BASE_URL: ${LANGFUSE_BASE_URL:-}

    ports:
      # 前端（通过 nginx）
      - "8081:80"
      # 后端 API（如果需要直接访问）
      - "8089:8088"
      # MinIO API
      - "19000:9000"
      # MinIO Console
      - "19001:9001"

    volumes:
      # MinIO 数据目录
      - ./volume/minio/data:/data
      # 日志目录（可选）- 挂载到特定子目录以避免覆盖
      - ./volume/logs/supervisor:/var/log/supervisor
      - ./volume/logs/nginx:/var/log/nginx
      - ./volume/logs/aix-db:/var/log/aix-db
      - ./volume/logs/minio:/var/log/minio

    networks:
      - aix-db-network

    depends_on:
      pgvector-db:
        condition: service_healthy

    extra_hosts:
      - "host.docker.internal:host-gateway"

    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # PostgreSQL 数据库（带 pgvector 扩展）
  pgvector-db:
    image: registry.cn-qingdao.aliyuncs.com/dataease/postgres:17.6
    container_name: pgvector-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-aix_db}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-1}
      POSTGRES_DB: ${POSTGRES_DB:-aix_db}
      TZ: Asia/Shanghai
    ports:
      - "5432:5432"
    volumes:
      - ./volume/pg_data:/var/lib/postgresql/data
      # 如果需要初始化 SQL
      - ./init_sql.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - aix-db-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-aix_db}" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  mysql:
    image: mysql:8.0.33
    container_name: mysql-db
    ports:
      - "13006:3306"
    networks:
      - aix-db-network
    environment:
      - MYSQL_ROOT_PASSWORD=1
      - CHARACTER_SET_SERVER=utf8mb4
      - COLLATION_SERVER=utf8mb4_unicode_ci
      - TZ=Asia/Shanghai
    volumes:
      - ./volume/mysql/data:/var/lib/mysql
      - ./my.cnf:/etc/mysql/conf.d/my.cnf

networks:
  aix-db-network:
    driver: bridge

# 可选：如果需要数据持久化
# volumes:
#   pg_data:
#   minio_data:
#   logs:
